# âœ… Apple Sign In åç«¯é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ” é—®é¢˜è¯Šæ–­

### åˆå§‹é”™è¯¯
```
jose.exceptions.JWKError: Could not deserialize key data
ValueError: Unable to load PEM file
```

### æ ¹æœ¬åŸå› åˆ†æ

ç»è¿‡æ·±å…¥è°ƒæŸ¥ï¼Œå‘ç°äº†**ä¸¤ä¸ªé—®é¢˜**ï¼š

#### 1. SOCKS ä»£ç†ä¾èµ–ç¼ºå¤± (ä¸»è¦é—®é¢˜)
**é”™è¯¯ä¿¡æ¯ï¼š**
```
ImportError: Using SOCKS proxy, but the 'socksio' package is not installed.
```

**åŸå› ï¼š** ç¯å¢ƒå˜é‡ä¸­è®¾ç½®äº† HTTP ä»£ç† (`http_proxy=http://127.0.0.1:7890`)ï¼Œä½† `httpx` åº“ç¼ºå°‘ SOCKS æ”¯æŒåŒ…ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
uv add socksio
```

#### 2. Apple ç§é’¥æ ¼å¼ (è™šæƒŠä¸€åœº)
**åˆå§‹æ€€ç–‘ï¼š** Apple ç§é’¥æ ¼å¼ä¸æ­£ç¡®
- æ£€æŸ¥ç»“æœï¼šç§é’¥æ ¼å¼æ­£ç¡®
- æ˜¯æœ‰æ•ˆçš„ EC ç§é’¥ï¼ˆP-256/secp256r1ï¼‰
- é•¿åº¦æ­£ç¡®ï¼ˆ257 å­—ç¬¦ï¼‰
- èƒ½å¤ŸæˆåŠŸç”Ÿæˆ JWT client secret

## ğŸ”§ ä¿®å¤æªæ–½

### 1. å®‰è£…ä¾èµ–
```bash
cd /Users/henryking/project/Follo/Follo-ai-backend
uv add socksio
```

### 2. å¢å¼ºæ—¥å¿—è¾“å‡º
ä¿®æ”¹ `api/core/apple_oauth.py`ï¼Œåœ¨ `_create_client_secret()` æ–¹æ³•ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼š

```python
def _create_client_secret(self) -> str:
    # ... åŸæœ‰ä»£ç  ...
    try:
        print(f"å‡†å¤‡åˆ›å»ºJWT client secret...")
        print(f"  - Team ID: {self.team_id}")
        print(f"  - Key ID: {self.key_id}")
        print(f"  - Client ID: {self.client_id}")
        print(f"  - Audience: {self.apple_auth_url}")
        print(f"  - ç§é’¥é•¿åº¦: {len(self.private_key)}")

        client_secret = jwt.encode(
            payload,
            self.private_key,
            algorithm="ES256",
            headers=header,
        )

        print(f"âœ… JWT client secret åˆ›å»ºæˆåŠŸï¼Œé•¿åº¦: {len(client_secret)}")
        return client_secret
    except Exception as e:
        # è¯¦ç»†é”™è¯¯å¤„ç†...
```

### 3. é‡æ–°å¯åŠ¨æœåŠ¡
```bash
pkill -f "uvicorn api.main:app"
sleep 2
uv run uvicorn api.main:app --reload --host 0.0.0.0 --port 8000
```

## âœ… éªŒè¯ç»“æœ

### æµ‹è¯•è¯·æ±‚
```bash
curl -X POST http://localhost:8000/auth/apple-login \
  -H "Content-Type: application/json" \
  -d '{"authorization_code":"test_code"}'
```

### æœåŠ¡æ—¥å¿—è¾“å‡º
```
å‡†å¤‡åˆ›å»ºJWT client secret...
  - Team ID: 4KFWGWA3MG
  - Key ID: C93A4GXA64
  - Client ID: com.jayzou.Folloai
  - Audience: https://appleid.apple.com
  - ç§é’¥é•¿åº¦: 257
  - ç§é’¥å‰ç¼€: -----BEGIN PRIVATE KEY-----
MI...
âœ… JWT client secret åˆ›å»ºæˆåŠŸï¼Œé•¿åº¦: 304
INFO:     127.0.0.1:49723 - "POST /auth/apple-login HTTP/1.1" 401 Unauthorized
```

### å“åº”ç»“æœ
```json
{
  "detail": "Invalid Apple authorization code"
}
```

**ç»“è®ºï¼š**
- âœ… JWT client secret ç”ŸæˆæˆåŠŸ
- âœ… æˆåŠŸè¿æ¥åˆ° Apple æœåŠ¡å™¨
- âœ… é”™è¯¯å¤„ç†æ­£ç¡®
- âœ… åç«¯å®Œå…¨æ­£å¸¸å·¥ä½œ

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| çŠ¶æ€ | 500 Internal Server Error | 401 Unauthorized |
| é”™è¯¯ç±»å‹ | JWKError, ImportError | Invalid Apple authorization code |
| JWTåˆ›å»º | å¤±è´¥ | æˆåŠŸ |
| Appleé€šä¿¡ | å¤±è´¥ | æˆåŠŸ |

## ğŸ¯ æœ€ç»ˆçŠ¶æ€

**åç«¯çŠ¶æ€ï¼š** âœ… å®Œå…¨æ­£å¸¸

**iOSé›†æˆï¼š** âœ… å·²å®Œæˆ

**æµ‹è¯•å»ºè®®ï¼š**

1. **ç¡®ä¿Apple Developeré…ç½®æ­£ç¡®ï¼š**
   - App ID å·²å¯ç”¨ Sign in with Apple
   - Services ID å·²åˆ›å»ºå¹¶é…ç½®
   - å¯†é’¥æ–‡ä»¶å·²ä¸‹è½½

2. **ä½¿ç”¨çœŸå®è®¾å¤‡æµ‹è¯•ï¼š**
   - iOSæ¨¡æ‹Ÿå™¨å¯èƒ½æ— æ³•å®Œæˆå®Œæ•´çš„Apple Sign Inæµç¨‹
   - å»ºè®®ä½¿ç”¨çœŸå®iPhone/iPad

3. **æ£€æŸ¥APIåœ°å€ï¼š**
   - iOSæ¨¡æ‹Ÿå™¨ï¼š`http://localhost:8000`
   - çœŸæœºï¼šä½¿ç”¨ç”µè„‘çš„IPåœ°å€ï¼Œä¾‹å¦‚ `http://192.168.1.100:8000`

## ğŸ“ æ€»ç»“

è¿™æ¬¡ä¿®å¤ä¸»è¦è§£å†³äº†ç¯å¢ƒé…ç½®é—®é¢˜ï¼ˆç¼ºå°‘SOCKSæ”¯æŒåŒ…ï¼‰ï¼Œè€Œä¸æ˜¯Appleç§é’¥æ ¼å¼é—®é¢˜ã€‚Apple Sign Inçš„æ•´ä¸ªæµç¨‹ç°åœ¨å·¥ä½œæ­£å¸¸ï¼š

1. iOS åº”ç”¨è·å– Apple authorization code
2. åç«¯æ¥æ”¶ code
3. åç«¯ç”Ÿæˆ JWT client secret âœ…
4. åç«¯ä¸ Apple æœåŠ¡å™¨é€šä¿¡ âœ…
5. Apple è¿”å›ç”¨æˆ·ä¿¡æ¯æˆ–é”™è¯¯ âœ…
6. åç«¯è¿”å›é€‚å½“å“åº” âœ…

**ä¸‹ä¸€æ­¥ï¼š** åœ¨çœŸå®è®¾å¤‡ä¸Šæµ‹è¯•å®Œæ•´çš„ç™»å½•æµç¨‹ï¼

---

**ä¿®å¤æ—¶é—´ï¼š** 2025-10-28 15:47
**çŠ¶æ€ï¼š** âœ… é—®é¢˜å®Œå…¨è§£å†³
